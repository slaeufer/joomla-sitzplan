(function() { const config = Joomla.getOptions('sitzplan'); const TN = config.participants; const NS = 'http://www.w3.org/2000/svg'; const SW = 34, SH = 28, GAP = 5; let seats = {}; let zones = config.zones || []; let mode = 'admin'; let sel = null; let zoneIdCtr = Math.max(...zones.map(z => z.id), 0); Object.entries(config.seats || {}).forEach(([key, seat]) => { seats[key] = { id: seat.person_id, name: seat.person_name, g: seat.person_gender }; }); const cfg = () => ({ rows: parseInt(config.config.rows) || 8, left: parseInt(config.config.seats_left) || 6, right: parseInt(config.config.seats_right) || 6, aisle: parseInt(config.config.aisle_width) || 44, }); window.setMode = function(m) { mode = m; document.querySelector('.mode-btn.admin').classList.toggle('active', m === 'admin'); document.querySelector('.mode-btn.helfer').classList.toggle('active', m === 'helfer'); render(); }; window.rebuild = function() { if (Object.keys(seats).length > 0 && !confirm('Neuaufbau setzt alle Zuweisungen zurück. Fortfahren?')) return; seats = {}; render(); renderList(); stats(); }; window.addZone = function() { const name = document.getElementById('zName').value.trim(); const count = parseInt(document.getElementById('zCount').value) || 5; const pos = document.getElementById('zPos').value; const gender = document.getElementById('zGender').value; if (!name) { alert('Bitte eine Bezeichnung eingeben.'); return; } const formData = new FormData(); formData.append('option', 'com_sitzplan'); formData.append('task', 'addZone'); formData.append('name', name); formData.append('count', count); formData.append('position', pos); formData.append('gender_rule', gender); formData.append(config.token, 1); fetch(Joomla.getOptions('system.paths').root + 'index.php', { method: 'POST', body: formData }).then(r => r.json()).then(data => { if (data.success) { zones.push({ id: data.id, name, count, position: pos, gender_rule: gender }); document.getElementById('zName').value = ''; renderZoneList(); render(); renderList(); stats(); } }); }; window.removeZone = function(id) { if (!confirm('Bereich löschen? Alle Zuweisungen gehen verloren.')) return; Object.keys(seats).forEach(k => { if (k.startsWith(`Z${id}_`)) delete seats[k]; }); const formData = new FormData(); formData.append('option', 'com_sitzplan'); formData.append('task', 'removeZone'); formData.append('zone_id', id); formData.append(config.token, 1); fetch(Joomla.getOptions('system.paths').root + 'index.php', { method: 'POST', body: formData }).then(r => r.json()).then(data => { if (data.success) { zones = zones.filter(z => z.id !== id); renderZoneList(); render(); renderList(); stats(); } }); }; function renderZoneList() { const el = document.getElementById('zoneList') || createZoneList(); if (!zones.length) { el.innerHTML = '<div style="font-size:.74rem;color:#bbb;padding:4px 0">Noch keine Sonderbereiche.</div>'; return; } el.innerHTML = zones.map(z => { const belegt = Object.keys(seats).filter(k => k.startsWith(`Z${z.id}_`)).length; return `<div class="zone-item"><div class="ztop"><span class="zone-label">${z.name}</span><div style="display:flex;gap:5px;align-items:center"><span class="zone-badge ${z.position}">${z.position}</span>${mode === 'admin' ? `<button class="zone-del" onclick="removeZone(${z.id})" title="Löschen">✕</button>` : ''}</div></div><div class="zone-info">${z.count} Stühle • ${z.gender_rule === 'offen' ? 'M & F' : z.gender_rule} • ${belegt}/${z.count} belegt</div></div>`; }).join(''); } function createZoneList() { const section = document.createElement('div'); section.id = 'zoneSection'; section.innerHTML = '<h2>Sonderbereiche</h2><div id="zoneList"></div>'; document.getElementById('sidebar').appendChild(section); return document.getElementById('zoneList'); } function ovRows(c) { const f = Object.values(seats).filter(s => s.g === 'F').length; const m = Object.values(seats).filter(s => s.g === 'M').length; const diff = Math.max(0, f - m); const rows = []; if (diff > 0) { const n = Math.ceil(diff / c.left); for (let i = 0; i < n; i++) rows.push(c.rows - i); } return rows; } function render() { const c = cfg(); const ov = ovRows(c); const blkL = c.left * (SW + GAP) - GAP; const blkR = c.right * (SW + GAP) - GAP; const offX = 44; const saalW = offX + blkL + c.aisle + blkR + 10; const zonesVorne = zones.filter(z => z.position === 'vorne'); const zonesHinten = zones.filter(z => z.position === 'hinten'); const zoneH = (zList) => zList.length ? zList.length * (SH + GAP + 18) + 10 : 0; const vorneH = zoneH(zonesVorne); const hintenH = zoneH(zonesHinten); const hauptH = 22 + c.rows * (SH + GAP + 4) + 8; const totalH = vorneH + hauptH + hintenH + 10; const totalW = Math.max(saalW, 400); const svg = document.createElementNS(NS, 'svg'); svg.setAttribute('width', totalW); svg.setAttribute('height', totalH); svg.style.display = 'block'; let curY = 0; if (zonesVorne.length) { tx(svg, offX, curY + 12, 'Sonderbereiche vorne', '#8e44ad', 10, true, 'start'); curY += 18; zonesVorne.forEach(z => { curY = drawZone(svg, z, offX, curY, blkL, blkR, c.aisle, saalW); }); curY += 6; drawLine(svg, offX, curY, saalW - 10, curY, '#c5cad5'); curY += 8; } tx(svg, offX + blkL / 2, curY + 14, 'Männer (links)', '#2980b9', 11, true); tx(svg, offX + blkL + c.aisle + blkR / 2, curY + 14, 'Frauen (rechts)', '#c0392b', 11, true); curY += 18; for (let r = 1; r <= c.rows; r++) { const y = curY + (r - 1) * (SH + GAP + 4); const isOv = ov.includes(r); tx(svg, offX - 6, y + SH / 2 + 4, String(r), '#bbb', 10, false, 'end'); for (let s = 1; s <= c.left; s++) drawSeat(svg, offX + (s - 1) * (SW + GAP), y, `R${r}_L${s}`, 'L', r, s, isOv); if (r === 1) tx(svg, offX + blkL + c.aisle / 2, y + SH / 2 + 4, 'Gang', '#ccc', 10, false, 'middle'); for (let s = 1; s <= c.right; s++) drawSeat(svg, offX + blkL + c.aisle + (s - 1) * (SW + GAP), y, `R${r}_R${s}`, 'R', r, s, false); if (isOv) tx(svg, offX + blkL + c.aisle / 2, y + SH / 2 + 4, 'Überlauf', '#e67e22', 8, false, 'middle'); } curY += c.rows * (SH + GAP + 4) + 4; if (zonesHinten.length) { drawLine(svg, offX, curY, saalW - 10, curY, '#c5cad5'); curY += 8; tx(svg, offX, curY + 12, 'Sonderbereiche hinten', '#16a085', 10, true, 'start'); curY += 18; zonesHinten.forEach(z => { curY = drawZone(svg, z, offX, curY, blkL, blkR, c.aisle, saalW); }); } const wrap = document.getElementById('svg-wrap'); wrap.innerHTML = ''; wrap.appendChild(svg); stats(); renderZoneList(); } function drawZone(svg, z, offX, startY, blkL, blkR, aisle, saalW) { const baseColor = z.position === 'vorne' ? '#8e44ad' : '#16a085'; tx(svg, offX, startY + 10, z.name, baseColor, 9, true, 'start'); const y = startY + 14; const totalSeatW = z.count * (SW + GAP) - GAP; const saalUsable = saalW - offX - 10; const startX = offX + Math.max(0, (saalUsable - totalSeatW) / 2); for (let s = 1; s <= z.count; s++) { const x = startX + (s - 1) * (SW + GAP); const key = `Z${z.id}_S${s}`; const occ = seats[key]; let fill = z.position === 'vorne' ? '#e8d5f5' : '#d0ede8'; if (occ) fill = occ.g === 'M' ? '#2980b9' : '#c0392b'; const g = document.createElementNS(NS, 'g'); g.style.cursor = mode === 'admin' ? 'pointer' : 'default'; const rect = document.createElementNS(NS, 'rect'); rect.setAttribute('x', x); rect.setAttribute('y', y); rect.setAttribute('width', SW); rect.setAttribute('height', SH); rect.setAttribute('rx', 5); rect.setAttribute('fill', fill); rect.setAttribute('stroke', occ ? 'rgba(0,0,0,.15)' : baseColor); rect.setAttribute('stroke-width', '1.5'); rect.setAttribute('stroke-dasharray', occ ? 'none' : '4,3'); g.addEventListener('mouseenter', () => rect.setAttribute('opacity', '.75')); g.addEventListener('mouseleave', () => rect.setAttribute('opacity', '1')); const lbl = document.createElementNS(NS, 'text'); lbl.setAttribute('x', x + SW / 2); lbl.setAttribute('y', y + SH / 2 + 4); lbl.setAttribute('text-anchor', 'middle'); lbl.setAttribute('font-size', '9'); lbl.setAttribute('fill', occ ? '#fff' : baseColor); lbl.setAttribute('pointer-events', 'none'); lbl.setAttribute('font-family', 'Segoe UI,Arial,sans-serif'); lbl.textContent = occ ? occ.name.split(' ').map(p => p[0]).join('').substring(0, 2).toUpperCase() : String(s); const title = document.createElementNS(NS, 'title'); title.textContent = occ ? `${occ.name} | ${z.name}, Stuhl ${s}` : `${z.name}, Stuhl ${s} — frei`; g.appendChild(title); g.appendChild(rect); g.appendChild(lbl); if (mode === 'admin') { g.addEventListener('click', () => openZonePopup(key, z, s)); } svg.appendChild(g); } return y + SH + 8; } function drawLine(svg, x1, y1, x2, y2, color) { const line = document.createElementNS(NS, 'line'); line.setAttribute('x1', x1); line.setAttribute('y1', y1); line.setAttribute('x2', x2); line.setAttribute('y2', y2); line.setAttribute('stroke', color); line.setAttribute('stroke-width', '1'); line.setAttribute('stroke-dasharray', '6,4'); svg.appendChild(line); } function drawSeat(svg, x, y, key, side, row, pos, isOv) { const occ = seats[key]; let fill = '#dde1e9'; if (occ) fill = occ.g === 'M' ? '#2980b9' : (side === 'R' ? '#c0392b' : '#e67e22'); else if (isOv && side === 'L') fill = '#fde8d0'; const g = document.createElementNS(NS, 'g'); g.style.cursor = mode === 'admin' ? 'pointer' : 'default'; const rect = document.createElementNS(NS, 'rect'); rect.setAttribute('x', x); rect.setAttribute('y', y); rect.setAttribute('width', SW); rect.setAttribute('height', SH); rect.setAttribute('rx', 5); rect.setAttribute('fill', fill); rect.setAttribute('stroke', occ ? 'rgba(0,0,0,.15)' : '#c8cdd8'); rect.setAttribute('stroke-width', '1'); g.addEventListener('mouseenter', () => rect.setAttribute('opacity', '.75')); g.addEventListener('mouseleave', () => rect.setAttribute('opacity', '1')); const lbl = document.createElementNS(NS, 'text'); lbl.setAttribute('x', x + SW / 2); lbl.setAttribute('y', y + SH / 2 + 4); lbl.setAttribute('text-anchor', 'middle'); lbl.setAttribute('font-size', '9'); lbl.setAttribute('fill', occ ? '#fff' : '#aaa'); lbl.setAttribute('pointer-events', 'none'); lbl.setAttribute('font-family', 'Segoe UI,Arial,sans-serif'); lbl.textContent = occ ? occ.name.split(' ').map(p => p[0]).join('').substring(0, 2).toUpperCase() : `${row}.${pos}`; const title = document.createElementNS(NS, 'title'); title.textContent = occ ? `${occ.name} | Reihe ${row}, Platz ${pos} ${side === 'L' ? 'links' : 'rechts'}` : `Reihe ${row}, Platz ${pos} ${side === 'L' ? 'links' : 'rechts'} — frei`; g.appendChild(title); g.appendChild(rect); g.appendChild(lbl); if (mode === 'admin') { g.addEventListener('click', () => openPopup(key, side, row, pos, isOv)); } svg.appendChild(g); } function tx(svg, x, y, text, fill, size, bold, anchor = 'middle') { const t = document.createElementNS(NS, 'text'); t.setAttribute('x', x); t.setAttribute('y', y); t.setAttribute('text-anchor', anchor); t.setAttribute('font-size', size); t.setAttribute('fill', fill); t.setAttribute('font-family', 'Segoe UI,Arial,sans-serif'); if (bold) t.setAttribute('font-weight', 'bold'); t.textContent = text; svg.appendChild(t); } window.openPopup = function(key, side, row, pos, isOv) { sel = { key, side, row, pos, isOv, zone: null }; const occ = seats[key]; document.getElementById('pTitle').textContent = occ ? 'Sitzplatz bearbeiten' : 'Sitzplatz zuweisen'; document.getElementById('pInfo').textContent = `Reihe ${row}, Platz ${pos} ${side === 'L' ? 'links' : 'rechts'}`; const taken = new Set(Object.values(seats).map(s => s.id)); const avail = TN.filter(p => !taken.has(p.id) || (occ && occ.id === p.id)); const rec = side === 'R' ? 'F' : (isOv ? 'F' : 'M'); buildPopupBody(avail, rec, occ, ''); document.getElementById('overlay').className = 'overlay on'; }; window.openZonePopup = function(key, zone, sNum) { sel = { key, side: null, row: null, pos: sNum, isOv: false, zone }; const occ = seats[key]; document.getElementById('pTitle').textContent = occ ? 'Stuhl bearbeiten' : 'Stuhl zuweisen'; document.getElementById('pInfo').textContent = `${zone.name}, Stuhl ${sNum}`; const taken = new Set(Object.values(seats).map(s => s.id)); const avail = TN.filter(p => { if (taken.has(p.id) && !(occ && occ.id === p.id)) return false; if (zone.gender_rule !== 'offen' && p.gender !== zone.gender_rule) return false; return true; }); const rec = zone.gender_rule === 'offen' ? null : zone.gender_rule; const hint = zone.gender_rule !== 'offen' ? `Dieser Bereich ist für ${zone.gender_rule === 'M' ? 'Männer' : 'Frauen'} reserviert.` : ''; buildPopupBody(avail, rec, occ, hint); document.getElementById('overlay').className = 'overlay on'; }; function buildPopupBody(avail, rec, occ, hint) { const yes = rec ? avail.filter(p => p.gender === rec) : avail; const no = rec ? avail.filter(p => p.gender !== rec) : []; let opts = '<option value="">-- Bitte wählen --</option>'; if (yes.length) { const grpLabel = rec ? (rec === 'M' ? 'Männer (empfohlen)' : 'Frauen (empfohlen)') : 'Alle Teilnehmer'; opts += `<optgroup label="${grpLabel}">`; yes.forEach(p => { opts += `<option value="${p.id}"${occ && occ.id === p.id ? ' selected' : ''}>${p.name} (${p.gender})</option>`; }); opts += '</optgroup>'; } if (no.length) { opts += `<optgroup label="${rec === 'M' ? 'Frauen (Regelverstoß!)' : 'Männer (Regelverstoß!)'}">`; no.forEach(p => { opts += `<option value="${p.id}"${occ && occ.id === p.id ? ' selected' : ''}>${p.name} (${p.gender})</option>`; }); opts += '</optgroup>'; } if (!yes.length && !no.length) { opts += '<option disabled>Keine verfügbaren Teilnehmer</option>'; } document.getElementById('pBody').innerHTML = ` ${hint ? `<div class="rule-warn on">${hint}</div>` : ''} <select id="pSel" onchange="chkRule(this)">${opts}</select> <div class="rule-warn" id="rW"></div> <div class="pactions"> <button class="ba" onclick="assign()">✓ Zuweisen</button> ${occ ? `<button class="bf" onclick="freeSeat()">✕ Freigeben</button>` : ''} <button class="bc" onclick="closePopup()">Abbrechen</button> </div> `; } window.chkRule = function(el) { if (!sel) return; const p = TN.find(t => t.id === +el.value); if (!p) return; const w = document.getElementById('rW'); let msg = ''; if (sel.zone) { if (sel.zone.gender_rule !== 'offen' && p.gender !== sel.zone.gender_rule) msg = `⚠️ Dieser Bereich ist für ${sel.zone.gender_rule === 'M' ? 'Männer' : 'Frauen'} reserviert!`; } else { if (sel.side === 'L' && !sel.isOv && p.gender === 'F') msg = '⚠️ Frau links — nur bei Überlauf-Reihen erlaubt!'; else if (sel.side === 'R' && p.gender === 'M') msg = '⚠️ Mann auf Frauenseite — Regelverstoß!'; } w.innerHTML = msg; w.className = 'rule-warn' + (msg ? ' on' : ''); }; window.assign = function() { const pid = +document.getElementById('pSel').value; if (!pid) { alert('Bitte eine Person auswählen.'); return; } const p = TN.find(t => t.id === pid); seats[sel.key] = { id: p.id, name: p.name, g: p.gender }; const formData = new FormData(); formData.append('option', 'com_sitzplan'); formData.append('task', 'saveSeat'); formData.append('seat_key', sel.key); formData.append('person_id', p.id); formData.append('person_name', p.name); formData.append('person_gender', p.gender); formData.append(config.token, 1); fetch(Joomla.getOptions('system.paths').root + 'index.php', { method: 'POST', body: formData }).then(() => { closePopup(); render(); renderList(); stats(); }); }; window.freeSeat = function() { delete seats[sel.key]; const formData = new FormData(); formData.append('option', 'com_sitzplan'); formData.append('task', 'freeSeat'); formData.append('seat_key', sel.key); formData.append(config.token, 1); fetch(Joomla.getOptions('system.paths').root + 'index.php', { method: 'POST', body: formData }).then(() => { closePopup(); render(); renderList(); stats(); }); }; window.closePopup = function() { document.getElementById('overlay').className = 'overlay'; sel = null; }; document.getElementById('overlay').addEventListener('click', e => { if (e.target === document.getElementById('overlay')) closePopup(); }); function stats() { const c = cfg(); const all = Object.values(seats); const m = all.filter(s => s.g === 'M').length; const f = all.filter(s => s.g === 'F').length; const zoneTotal = zones.reduce((sum, z) => sum + z.count, 0); const tot = c.rows * (c.left + c.right) + zoneTotal; let statsHTML = ` <h2>Belegung</h2> <div class="stats"> <div class="sbox sm"><div class="n">${m}</div><div class="l">Männer</div></div> <div class="sbox sf"><div class="n">${f}</div><div class="l">Frauen</div></div> <div class="sbox sfr"><div class="n">${tot - all.length}</div><div class="l">Frei</div></div> <div class="sbox sg"><div class="n">${tot}</div><div class="l">Gesamt</div></div> </div> ${f > m ? '<div class="warn-box on">⚠️ Mehr Frauen als Männer — hintere Reihen links als Überlauf freigegeben.</div>' : '<div class="warn-box"></div>'} `; let existing = document.getElementById('statsSection'); if (!existing) { existing = document.createElement('div'); existing.id = 'statsSection'; document.getElementById('sidebar').appendChild(existing); } existing.innerHTML = statsHTML; } function renderList() { const taken = new Set(Object.values(seats).map(s => s.id)); let plistHTML = `<h2>Teilnehmer</h2> <div class="plist"> ${TN.map(p => { const done = taken.has(p.id); const seatKey = Object.keys(seats).find(k => seats[k].id === p.id); let wo = ''; if (seatKey) { if (seatKey.startsWith('Z')) { const zid = +seatKey.split('_')[0].replace('Z', ''); const z = zones.find(z => z.id === zid); wo = z ? ` (${z.name})` : ''; } else { const m = seatKey.match(/R(\d+)_([LR])(\d+)/); if (m) wo = ` (R${m[1]} ${m[2] === 'L' ? 'li' : 're'})`; } } return `<div class="pitem ${done ? 'done' : 'open'}"> <div class="pd" style="background:${p.gender === 'M' ? '#2980b9' : '#c0392b'}"></div> ${p.name}${done ? ` ✓${wo}` : ''} </div>`; }).join('')} </div> `; let existing = document.getElementById('plistSection'); if (!existing) { existing = document.createElement('div'); existing.id = 'plistSection'; document.getElementById('sidebar').appendChild(existing); } existing.innerHTML = plistHTML; } const sidebar = document.getElementById('sidebar'); sidebar.innerHTML = ` <div id="configSection"> <h2>Raumkonfiguration</h2> <div class="cfg-grid"> <div><label>Reihen</label><input id="cR" type="number" value="${cfg().rows}" min="1" max="30"></div> <div><label>Sitze links</label><input id="cL" type="number" value="${cfg().left}" min="1" max="20"></div> <div><label>Sitze rechts</label><input id="cRR" type="number" value="${cfg().right}" min="1" max="20"></div> <div><label>Gang (px)</label><input id="cG" type="number" value="${cfg().aisle}" min="10" max="120"></div> </div> <button class="btn-build" onclick="rebuild()">↻ Saal neu aufbauen</button> </div> <div id="zoneAddSection"> <h2>Sonderbereiche</h2> <div id="zoneList"></div> <div class="add-zone-form" style="margin-top:10px"> <div> <label>Bezeichnung</label> <input id="zName" type="text" placeholder="z.B. Ehrenreihe, Orchester"> </div> <div class="cfg-grid"> <div> <label>Anzahl Stühle</label> <input id="zCount" type="number" value="5" min="1" max="30"> </div> <div> <label>Position</label> <select id="zPos"> <option value="vorne">Vorne</option> <option value="hinten">Hinten</option> </select> </div> </div> <div> <label>Geschlecht-Regel</label> <select id="zGender"> <option value="offen">Offen (M & F)</option> <option value="M">Nur Männer</option> <option value="F">Nur Frauen</option> </select> <button class="btn-addzone" onclick="addZone()">+ Bereich hinzufügen</button> </div> </div> <div id="legendSection"> <h2>Legende</h2> <div class="legend"> <div class="leg"><div class="ldot" style="background:#dde1e9"></div>Frei (Hauptraster)</div> <div class="leg"><div class="ldot" style="background:#2980b9"></div>Mann (links)</div> <div class="leg"><div class="ldot" style="background:#c0392b"></div>Frau (rechts)</div> <div class="leg"><div class="ldot" style="background:#e67e22"></div>Frau links (Überlauf)</div> <div class="leg"><div class="ldot" style="background:#8e44ad"></div>Sonderbereich vorne</div> <div class="leg"><div class="ldot" style="background:#16a085"></div>Sonderbereich hinten</div> </div> </div> `; document.getElementById('eventName').textContent = config.config.event_name || 'Musterveranstaltung 2025'; render(); renderList(); stats(); })();